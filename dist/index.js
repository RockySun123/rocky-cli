"use strict";var e=require("tslib"),o=require("commander"),i=require("@inquirer/prompts"),r=require("simple-git"),t=require("progress-estimator"),n=require("chalk"),s=require("log-symbols"),c=require("figlet"),l=require("node:path"),a=require("fs-extra"),u=require("axios"),d=require("lodash"),g=require("node:child_process"),p=require("ora"),v="0.2.0";const m=e=>{console.log(s.success,e)},y=e=>{console.log(s.error,e)},h=e=>{console.log(s.info,e)},b=t({spinner:{interval:100,frames:["⠋","⠙","⠹","⠸","⠼","⠴","⠦","⠧","⠇","⠏"].map((e=>n.green(e)))}}),w={baseDir:process.cwd(),binary:"git",maxConcurrentProcesses:6,trimmed:!1},f=(o,i,t)=>e.__awaiter(void 0,void 0,void 0,(function*(){const s=r(w);try{yield b(s.clone(o,i,t),"代码下载中...",{estimate:7e3}),yield e.__awaiter(void 0,void 0,void 0,(function*(){const e=yield c("rockys-cli");console.log(n.rgb(40,156,193).visible(e))})),console.log(""),console.log(n.blueBright("============================")),console.log(n.blueBright("= 欢迎使用 rocky-cli脚手架 =")),console.log(n.blueBright("============================")),console.log(""),m(n.blackBright("项目创建成功")+" "+n.blueBright(i)),m(n.blackBright("请按照以下步骤进行操作:")),h(n.blackBright("cd ",n.blueBright(i))),h(n.yellow("pnpm ",n.blackBright("install"))),h(n.yellow("pnpm ",n.blackBright("run dev")))}catch(e){y(n.red("下载失败")),console.log(e)}})),k=o=>e.__awaiter(void 0,void 0,void 0,(function*(){const{data:i}=yield(r=o,e.__awaiter(void 0,void 0,void 0,(function*(){const e=`https://registry.npmjs.org/${r}`;let o={};try{o=yield u.get(e)}catch(e){console.error(e)}return o})));var r;return i["dist-tags"].latest})),_=new Map([["vite-vue3-typescript-template",{name:"vite-vue3-typescript-template",downloadUrl:"git@gitee.com:sun-kelin/vue-infrastructure.git",description:"Vue3 技术栈开发模版",branch:"master"}],["vite-template",{name:"vite-vue3-typescript-template",downloadUrl:"git@gitee.com:sun-kelin/vue-infrastructure.git",description:"Vue 技术栈开发模版",branch:"dev-rocky"}],["vite-vue3-Vant-typescript-h5-template",{name:"vite-vue3-Vant-typescript-h5-template",downloadUrl:"git@gitee.com:sun-kelin/vue-infrastructure.git",description:"Vue H5 技术栈开发模版",branch:"h5"}]]);function q(o){return e.__awaiter(this,void 0,void 0,(function*(){const r=Array.from(_).map((e=>{const[o,i]=e;return{name:o,value:o,description:i.description}}));o||(o=yield i.input({message:"请输入项目名称"}));const t=l.resolve(process.cwd(),o);if(a.existsSync(t)){const r=yield(o=>e.__awaiter(void 0,void 0,void 0,(function*(){return console.warn(`${o} 文件夹已存在`),i.select({message:"是否覆盖",choices:[{name:"覆盖",value:!0},{name:"取消",value:!1}]})})))(o);if(!r)return;a.removeSync(t)}yield((o,i)=>e.__awaiter(void 0,void 0,void 0,(function*(){const e=yield k(o),r=d.gt(e,i);return r&&(console.warn(`检测到最新版本：${n.blueBright(e)}, 当前版本：${n.blueBright(i)}`),console.log(`可使用：${n.yellow("npm install rockys-cli@latest -g")}, 或者使用：${n.yellow("rockys update")} 更新`)),r})))("rockys-cli",v);const s=yield i.select({message:"请选择模版",choices:r}),c=_.get(s);c&&(yield f(c.downloadUrl,o,["-b",c.branch]))}))}const B=p({text:"rockys-cli 正在更新中...",spinner:{interval:100,frames:["⠋","⠙","⠹","⠸","⠼","⠴","⠦","⠧","⠇","⠏"].map((e=>n.green(e)))}}),x=new o.Command;x.name("rocky").description("自定义脚手架").version(v,"-v, --version"),x.command("create").description("创建新项目").argument("[name]","项目名称").action((function(o){return e.__awaiter(this,void 0,void 0,(function*(){q(o)}))})),x.command("update").description("更新脚手架").action((()=>e.__awaiter(void 0,void 0,void 0,(function*(){yield e.__awaiter(void 0,void 0,void 0,(function*(){return B.start(),g.exec("npm install rockys-cli@latest -g",((e,o)=>{B.stop(),e?(console.log(n.red("更新失败")),console.log(e)):console.log(n.green("更新成功"))}))}))})))),x.parse(),process.on("SIGINT",(()=>{console.log(`强制退出 ${n.blue("rockys-cli")}`),process.exit(0)})),process.on("uncaughtException",(e=>{"ExitPromptError"===e.name?(console.log(`退出 ${n.blue("rockys-cli")}`),process.exit(0)):(console.log(n.red("rockys-cli 发生未处理的错误:"),e),process.exit(1))}));
